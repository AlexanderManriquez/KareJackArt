<div class="admin-artworks">
  <h1>Crear nueva obra</h1>

  <div id="message" style="margin-bottom:12px;color:green"></div>

  <form id="artworkForm" enctype="multipart/form-data">
    <div>
      <label for="title">Título</label>
      <input type="text" id="title" name="title" required />
    </div>

    <div>
      <label for="slug">Slug (opcional)</label>
      <input type="text" id="slug" name="slug" />
    </div>

    <div>
      <label for="description">Descripción</label>
      <textarea id="description" name="description" rows="4"></textarea>
    </div>

    <div>
      <label for="dimensions">Dimensiones</label>
      <input type="text" id="dimensions" name="dimensions" />
    </div>

    <div>
      <label for="year">Año</label>
      <input type="number" id="year" name="year" />
    </div>

    <div>
      <label for="isFeatured">Destacar</label>
      <input type="checkbox" id="isFeatured" name="isFeatured" />
    </div>

    <div>
      <label for="image">Imagen</label>
      <input type="file" id="image" name="image" accept="image/*" required />
    </div>

    <div style="margin-top:12px;">
      <button type="button" id="createArtworkBtn" onclick="submitArtwork()">Crear obra</button>
    </div>
  </form>

  <script>
      console.log('admin/artworks script loaded');
    (function () {
      const form = document.getElementById('artworkForm');
      const message = document.getElementById('message');
      const btn = document.getElementById('createArtworkBtn');

      async function submitArtwork() {
        try {
          message.style.color = 'black';
          message.textContent = 'Subiendo...';

          // Build FormData manually to ensure file is attached
          const fd = new FormData();
          // Append textual fields
          fd.append('title', document.getElementById('title').value);
          fd.append('slug', document.getElementById('slug').value);
          fd.append('description', document.getElementById('description').value);
          fd.append('dimensions', document.getElementById('dimensions').value);
          fd.append('year', document.getElementById('year').value);
          fd.append('isFeatured', document.getElementById('isFeatured').checked ? 'on' : '');
          // Append file explicitly
          const fileInput = document.getElementById('image');
          const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
          if (file) fd.append('image', file, file.name);

          // Debug: log FormData entries
          for (const pair of fd.entries()) {
            console.log('FormData entry:', pair[0], pair[1] && pair[1].name ? '(file) ' + pair[1].name : pair[1]);
          }
          // If token stored in localStorage, add Authorization header
          const token = localStorage.getItem('token');

          const headers = {};
          if (token) headers['Authorization'] = 'Bearer ' + token;

          console.log('Enviando artwork, headers:', headers);

          const res = await fetch('/api/artworks', {
            method: 'POST',
            body: fd,
            headers,
            credentials: 'include',
          });

          console.log('Fetch completed, status:', res.status);
          const contentType = res.headers.get('content-type') || '';
          const json = contentType.includes('application/json') ? await res.json() : { message: await res.text() };
          console.log('Response JSON/Text:', json);

          if (!res.ok) {
            message.style.color = 'red';
            message.textContent = json.error || json.message || 'Error al crear obra';
            return;
          }

          message.style.color = 'green';
          message.textContent = 'Obra creada correctamente.';
          form.reset();
        } catch (err) {
          console.error('Error al subir artwork:', err);
          message.style.color = 'red';
          message.textContent = err.message || 'Error de red';
        }
      }

      // Expose globally as a fallback for inline onclick
      try { window.submitArtwork = submitArtwork; } catch (e) { /* ignore */ }

      btn.addEventListener('click', submitArtwork);
    })();
  </script>
</div>
